{% extends "base.html" %}

{% block title %}{{ project.name }}{% endblock %}

{% block content %}
<section class="content-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <h1>{{ project.name }}</h1>
      </div>
    </div>
  </div>
</section>

<section class="content pb-3">
  <div class="container-fluid h-100">
    <div class="row mb-3">
      <div class="col-12">
        <a href="{{ url_for('kanban.create_column', project_id=project.id) }}" class="btn btn-primary">Criar Coluna</a>
        <a href="{{ url_for('kanban.edit_project', project_id=project.id) }}" class="btn btn-secondary">Editar Projeto</a>
        <a href="{{ url_for('kanban.add_user_to_project', project_id=project.id) }}" class="btn btn-success">Adicionar Usu치rio</a>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="kanban-board">
          {% for column in project.columns %}
          <div class="kanban-column card card-row card-{{ loop.cycle('secondary', 'primary', 'info', 'success', 'danger') }}">
            <div class="card-header">
              <h3 class="card-title">{{ column.name }}</h3>
              <div class="card-tools">
                <a href="{{ url_for('kanban.edit_column', column_id=column.id) }}" class="btn btn-tool"><i class="fas fa-pen"></i></a>
                <a href="{{ url_for('kanban.create_task', column_id=column.id) }}" class="btn btn-tool"><i class="fas fa-plus"></i></a>
              </div>
            </div>
            <div class="card-body kanban-tasks" id="column-{{ column.id }}">
              {% for task in column.tasks %}
              <div class="card card-info card-outline" data-task-id="{{ task.id }}">
                <div class="card-header">
                  <h5 class="card-title">
                    {{ task.title }}
                    <a href="{{ url_for('kanban.edit_task', task_id=task.id) }}" class="btn"><i class="fas fa-pen"></i></a>
                  </h5>
                </div>
                <div class="card-body">
                  <p>{{ task.description }}</p>
                  <p><strong>Respons치vel:</strong> {{ task.responsible.name }}</p>
                  <p><strong>Solicitante:</strong> {{ task.requester.name }}</p>
                  {% if task.due_date %}
                  <p><strong>Prazo de Entrega:</strong> {{ task.due_date.strftime('%d/%m/%Y %H:%M') }}</p>
                  {% endif %}
                  <p><strong>Prioridade:</strong> {{ task.priority }}</p>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block head %}
<style>
  .kanban-board {
    display: flex;
    overflow-x: auto;
    padding-bottom: 10px;
  }
  .kanban-column {
    flex: 0 0 300px;
    margin-right: 10px;
    max-height: calc(100vh - 200px); /* Ajuste conforme necess치rio para compensar o header e outros elementos */
    overflow-y: auto;
  }
  .kanban-tasks {
    overflow-y: auto;
    max-height: calc(100vh - 250px); /* Ajuste conforme necess치rio para compensar o header da coluna */
  }
</style>
{% endblock %}

{% block script %}
<script src="{{ url_for('static', filename='js/Sortable.js') }}" defer></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const columns = document.querySelectorAll('.kanban-tasks');

    columns.forEach(column => {
      new Sortable(column, {
        group: 'shared',
        animation: 150,
        onEnd: function (evt) {
          const taskId = evt.item.getAttribute('data-task-id');
          const newColumnId = evt.to.getAttribute('id').replace('column-', '');

          fetch('{{ url_for("kanban.move_task") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              task_id: taskId,
              column_id: newColumnId
            })
          }).then(response => {
            if (!response.ok) {
              console.error('Failed to move task');
            } else {
              console.log('Task moved successfully');
            }
          });
        }
      });
    });
  });
</script>
{% endblock %}
